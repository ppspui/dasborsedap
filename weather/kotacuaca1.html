<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Animasi Kota: Sungai & Cuaca</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #2c3e50;
        }
        canvas {
            display: block;
        }
        #controls-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 15px;
            border-left: 4px solid #3498db;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            z-index: 20;
            backdrop-filter: blur(8px);
            width: 220px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            transition: all 0.3s ease;
        }
        input[type=range] {
            width: 100%;
            margin: 10px 0;
            cursor: pointer;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            -webkit-appearance: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #f1c40f;
            cursor: pointer;
            margin-top: -5px; 
        }
        #atmosphereLabel {
            font-size: 14px;
            font-weight: bold;
            color: #f1c40f;
            text-align: center;
            margin-bottom: 2px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        .instruction {
            font-size: 10px;
            color: #bdc3c7;
            text-align: center;
            margin-bottom: 10px;
        }
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        /* Switch Toggle Style */
        .switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
        }
        .switch input { 
            opacity: 0; 
            width: 0; 
            height: 0; 
            position: absolute;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #95a5a6;
            transition: .4s;
            border-radius: 20px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #2ecc71; }
        input:checked + .slider:before { transform: translateX(14px); }
        
        #loading-text {
            font-size: 10px;
            color: #3498db;
            text-align: center;
            display: none;
            margin-top: 5px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div id="controls-panel">
        <div id="atmosphereLabel">Musim Semi Cerah ðŸŒ¸</div>
        <input type="range" id="atmosphereSlider" min="0" max="6" step="1" value="0" oninput="updateAtmosphere()">
        <div class="instruction">Geser slider untuk ubah cuaca</div>
        
        <div class="toggle-container">
            <span>Mode Otomatis (Live)</span>
            <label class="switch">
                <input type="checkbox" id="autoToggle" onchange="toggleAutoMode()">
                <span class="slider"></span>
            </label>
        </div>
        <div id="loading-text">Mengambil data lokasi...</div>
    </div>
    
    <canvas id="stormCanvas"></canvas>

    <script>
        const canvas = document.getElementById('stormCanvas');
        const ctx = canvas.getContext('2d');

        let width, height;
        let groundLevel; // Top of Road
        let sidewalkLevel; // Top of Sidewalk
        let riverLevel; // Top of River (Bottom of Road)
        
        // --- STATUS ATMOSFER ---
        let season = 'spring';
        let weather = 'clear';
        let isAutoMode = false;
        
        // Parameter Lingkungan
        let windSpeed = 1;
        let skyColorTop = '#3498db';
        let skyColorBot = '#ecf0f1';
        let riverColorTop = '#2980b9'; 
        let riverColorBot = '#2c3e50';
        let overlayColor = 'rgba(0,0,0,0)';
        let lightningChance = 0;
        
        let lightningTimer = 0;
        let flashOpacity = 0;
        let thunderBolts = [];
        
        // --- OBJEK (Arrays) ---
        const particles = [];
        const splashes = [];
        const clouds = [];
        let buildings = [];
        let cityscapeLayers = [];
        let hawkers = [];
        const vehicles = [];
        const pedestrians = [];
        const boats = []; 
        let streetLights = [];
        let monorail;
        let highSpeedTrain;
        let busStop;
        let helicopters = [];
        
        let vehicleTimer = 0;
        let pedestrianTimer = 0;
        let boatTimer = 0;
        let heliTimer = 0;

        // ==========================================
        //        DEFINISI KELAS (DIPINDAH KE ATAS)
        // ==========================================

        class Boat {
            constructor() {
                this.type = ['cargo', 'ferry', 'speed', 'canoe'][Math.floor(Math.random()*4)];
                this.direction = Math.random() > 0.5 ? 1 : -1;
                this.y = riverLevel + 20 + Math.random() * (height - riverLevel - 40);
                this.bobOffset = Math.random() * 10;
                
                if (this.type === 'cargo') {
                    this.w = 120; this.h = 30; this.speed = 0.5 * this.direction;
                    this.color = '#7f8c8d';
                } else if (this.type === 'ferry') {
                    this.w = 80; this.h = 25; this.speed = 1.2 * this.direction;
                    this.color = '#ecf0f1';
                } else if (this.type === 'speed') {
                    this.w = 40; this.h = 15; this.speed = 3.5 * this.direction;
                    this.color = '#e74c3c';
                } else {
                    this.w = 30; this.h = 10; this.speed = 0.8 * this.direction;
                    this.color = '#d35400';
                }
                
                this.x = this.direction === 1 ? -this.w - 50 : width + 50;
            }
            update() {
                this.x += this.speed;
                this.bobOffset += 0.05;
                if ((this.direction === 1 && this.x > width + 100) || (this.direction === -1 && this.x < -200)) return true;
                return false;
            }
            draw() {
                let bob = Math.sin(this.bobOffset) * 2;
                ctx.save();
                ctx.translate(this.x, this.y + bob);
                if (this.direction === -1) ctx.scale(-1, 1); 

                // Wake Effect
                if (this.type === 'speed') {
                    ctx.fillStyle = 'rgba(255,255,255,0.4)';
                    ctx.beginPath(); ctx.moveTo(-10, this.h); ctx.lineTo(-60, this.h - 5); ctx.lineTo(-10, this.h + 5); ctx.fill();
                }

                ctx.fillStyle = this.color;
                if (this.type === 'canoe') {
                    ctx.beginPath(); ctx.moveTo(0, 0); ctx.quadraticCurveTo(this.w/2, this.h*2, this.w, 0); ctx.fill();
                    ctx.fillStyle = '#222'; ctx.fillRect(this.w/2 - 2, -10, 4, 10);
                    ctx.beginPath(); ctx.arc(this.w/2, -12, 3, 0, Math.PI*2); ctx.fill();
                } else {
                    ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(this.w, 0); ctx.lineTo(this.w - 10, this.h); ctx.lineTo(10, this.h); ctx.fill();
                    if (this.type === 'cargo') {
                        ctx.fillStyle = '#c0392b'; ctx.fillRect(10, -15, 20, 15);
                        ctx.fillStyle = '#2980b9'; ctx.fillRect(35, -15, 20, 15);
                        ctx.fillStyle = '#f1c40f'; ctx.fillRect(60, -15, 20, 15);
                        ctx.fillStyle = '#ecf0f1'; ctx.fillRect(this.w - 30, -20, 20, 20);
                    } else if (this.type === 'ferry') {
                        ctx.fillStyle = '#fff'; ctx.fillRect(10, -15, this.w - 20, 15);
                        ctx.fillStyle = '#3498db'; ctx.fillRect(15, -10, 5, 5); ctx.fillRect(25, -10, 5, 5); ctx.fillRect(35, -10, 5, 5);
                    }
                }
                ctx.restore();
            }
        }

        class BusStop {
            constructor(x, y) {
                this.x = x; this.y = y; this.w = 120; this.h = 60;
            }
            draw() {
                ctx.fillStyle = '#34495e';
                ctx.beginPath(); ctx.moveTo(this.x, this.y - this.h); ctx.lineTo(this.x + this.w, this.y - this.h - 10); ctx.lineTo(this.x + this.w + 10, this.y - this.h + 5); ctx.lineTo(this.x - 10, this.y - this.h + 5); ctx.fill();
                ctx.fillStyle = '#2c3e50'; ctx.fillRect(this.x + 10, this.y - this.h, 10, this.h); ctx.fillRect(this.x + this.w - 20, this.y - this.h, 10, this.h);
                ctx.fillStyle = 'rgba(100, 150, 200, 0.3)'; ctx.fillRect(this.x + 20, this.y - this.h + 10, this.w - 40, this.h - 20);
                ctx.fillStyle = '#7f8c8d'; ctx.fillRect(this.x + 25, this.y - 20, this.w - 50, 5); ctx.fillRect(this.x + 30, this.y - 20, 5, 20); ctx.fillRect(this.x + this.w - 35, this.y - 20, 5, 20);
                ctx.fillStyle = '#f1c40f'; ctx.beginPath(); ctx.arc(this.x - 15, this.y - this.h, 10, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = 'black'; ctx.font = 'bold 10px Arial'; ctx.fillText('BUS', this.x - 24, this.y - this.h + 4);
                ctx.fillStyle = '#7f8c8d'; ctx.fillRect(this.x - 17, this.y - this.h, 4, this.h);
            }
        }

        class Helicopter {
            constructor() {
                this.x = -100; this.y = Math.random() * 100 + 50; this.state = 'flying';
                this.targetBuilding = null;
                let pads = buildings.filter(b => b.hasHelipad);
                if (pads.length > 0 && Math.random() > 0.5) {
                    this.targetBuilding = pads[0]; this.landingX = this.targetBuilding.x + this.targetBuilding.w/2; this.landingY = sidewalkLevel - this.targetBuilding.h - 15; this.state = 'landing';
                }
                this.speedX = 3; this.speedY = 0; this.waitTimer = 0; this.rotorAngle = 0;
            }
            update() {
                this.rotorAngle += 0.8;
                if (this.state === 'flying') this.x += this.speedX;
                else if (this.state === 'landing') {
                    let dx = this.landingX - this.x; let dy = this.landingY - this.y;
                    if (Math.abs(dx) > 5) this.x += (dx > 0 ? 2 : -2);
                    else { if (dy > 2) this.y += 1; else { this.state = 'landed'; this.waitTimer = 300; } }
                } else if (this.state === 'landed') { this.waitTimer--; if (this.waitTimer <= 0) this.state = 'takingoff'; } 
                else if (this.state === 'takingoff') { this.y -= 1.5; if (this.y < 50) this.state = 'flying'; }
                return this.x > width + 200;
            }
            draw() {
                ctx.save(); ctx.translate(this.x, this.y);
                if(this.state === 'landed') ctx.rotate(0); else ctx.rotate(0.1);
                ctx.fillStyle = '#34495e'; ctx.beginPath(); ctx.ellipse(0, 0, 30, 15, 0, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#2c3e50'; ctx.fillRect(-45, -5, 25, 5); ctx.fillRect(-48, -10, 5, 15);
                ctx.fillStyle = 'rgba(135, 206, 235, 0.8)'; ctx.beginPath(); ctx.arc(10, 0, 12, 0, Math.PI*2, true); ctx.fill();
                ctx.strokeStyle = '#222'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(-10, 10); ctx.lineTo(-10, 18); ctx.lineTo(15, 18); ctx.moveTo(10, 10); ctx.lineTo(10, 18); ctx.stroke();
                ctx.fillStyle = 'rgba(20, 20, 20, 0.8)'; let bladeW = Math.sin(this.rotorAngle) * 70; ctx.fillRect(-35, -15, 70, 2); ctx.fillRect(-bladeW/2, -18, bladeW, 4);
                if (this.state !== 'landed') { ctx.fillStyle = Math.random() > 0.5 ? 'red' : 'rgba(0,0,0,0)'; ctx.beginPath(); ctx.arc(-48, -12, 2, 0, Math.PI*2); ctx.fill(); }
                ctx.restore();
            }
        }

        class HighSpeedTrainSystem {
            constructor(y) { this.y = y; this.train = null; this.timer = 200; }
            update() {
                if (this.train) { this.train.update(); if (this.train.x > width + 1000 || this.train.x < -1000) { this.train = null; this.timer = 300 + Math.random()*300; } } 
                else { this.timer--; if(this.timer<=0) { let dir = Math.random() > 0.5 ? 1 : -1; this.train = new HighSpeedTrain(this.y, dir); } }
            }
            drawTrack() {
                ctx.fillStyle = '#bdc3c7'; for(let x=20; x<width; x+=300) ctx.fillRect(x, this.y, 25, sidewalkLevel - this.y);
                ctx.fillStyle = '#ecf0f1'; ctx.fillRect(0, this.y, width, 20); ctx.fillStyle = '#bdc3c7'; ctx.fillRect(0, this.y+15, width, 5);
            }
            drawTrain() { if(this.train) this.train.draw(); }
        }

        class HighSpeedTrain {
            constructor(y, dir) { this.y = y - 25; this.dir = dir; this.w = 500; this.h = 25; this.x = dir===1 ? -this.w : width + this.w; this.speed = 20 * dir; }
            update() { this.x += this.speed; }
            draw() {
                ctx.save(); ctx.fillStyle = '#fff'; ctx.beginPath();
                if(this.dir === 1) { ctx.moveTo(this.x, this.y); ctx.lineTo(this.x + this.w, this.y); ctx.quadraticCurveTo(this.x + this.w + 60, this.y + 12, this.x + this.w, this.y + this.h); ctx.lineTo(this.x, this.y + this.h); } 
                else { ctx.moveTo(this.x + this.w, this.y); ctx.lineTo(this.x, this.y); ctx.quadraticCurveTo(this.x - 60, this.y + 12, this.x, this.y + this.h); ctx.lineTo(this.x + this.w, this.y + this.h); }
                ctx.fill(); ctx.fillStyle = '#222'; ctx.fillRect(this.x + 20, this.y + 8, this.w - 40, 8);
                ctx.fillStyle = '#3498db'; ctx.fillRect(this.x, this.y + 18, this.w, 4); ctx.restore();
            }
        }

        class MonorailSystem {
            constructor(y) { this.y = y; this.train = null; this.timer = 100; this.pillarSpacing = 200; }
            update() {
                if (this.train) { this.train.update(); if ((this.train.direction === 1 && this.train.x > width + 100) || (this.train.direction === -1 && this.train.x < -this.train.w - 100)) { this.train = null; this.timer = 500 + Math.random() * 500; } } 
                else { this.timer--; if (this.timer <= 0) this.spawnTrain(); }
            }
            spawnTrain() { let dir = Math.random() > 0.5 ? 1 : -1; this.train = new MonorailTrain(this.y, dir); }
            drawTrack() {
                ctx.fillStyle = '#34495e'; for (let x = 50; x < width; x += this.pillarSpacing) ctx.fillRect(x, this.y, 20, sidewalkLevel - this.y);
                ctx.fillStyle = '#2c3e50'; ctx.fillRect(0, this.y, width, 15); ctx.fillStyle = '#1a252f'; ctx.fillRect(0, this.y + 15, width, 5);
                ctx.fillStyle = '#5dade2'; for(let i=0; i<width; i+=40) ctx.fillRect(i, this.y + 5, 4, 4);
            }
            drawTrain() { if (this.train) this.train.draw(); }
        }

        class MonorailTrain {
            constructor(y, direction) { this.y = y - 22; this.direction = direction; this.w = 250; this.h = 24; this.x = direction === 1 ? -this.w : width + this.w; this.speed = 3 * direction; }
            update() { this.x += this.speed; }
            draw() {
                ctx.save(); ctx.fillStyle = '#ecf0f1'; let carW = this.w / 3; let gap = 2;
                for(let i=0; i<3; i++) {
                    let carX = this.x + (i * (carW - gap)); ctx.fillStyle = '#ecf0f1'; ctx.fillRect(carX, this.y, carW - gap, this.h);
                    ctx.fillStyle = 'rgba(100, 200, 255, 0.8)'; ctx.fillRect(carX + 5, this.y + 5, carW - 15, 8); ctx.fillStyle = '#e74c3c'; ctx.fillRect(carX, this.y + 15, carW - gap, 2);
                }
                ctx.globalCompositeOperation = 'screen'; let beamLen = 150; let headX = this.direction === 1 ? this.x + this.w - 10 : this.x + 10;
                let grad = ctx.createLinearGradient(this.x, this.y, this.x + (beamLen * this.direction), this.y);
                grad.addColorStop(0, 'rgba(200, 255, 255, 0.5)'); grad.addColorStop(1, 'rgba(0,0,0,0)'); ctx.fillStyle = grad;
                ctx.beginPath(); if (this.direction === 1) { ctx.moveTo(headX, this.y + 5); ctx.lineTo(headX + beamLen, this.y + 30); ctx.lineTo(headX, this.y + 15); } else { ctx.moveTo(headX, this.y + 5); ctx.lineTo(headX - beamLen, this.y + 30); ctx.lineTo(headX, this.y + 15); }
                ctx.fill(); ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(headX, this.y + 10, 2, 0, Math.PI*2); ctx.fill(); ctx.restore();
            }
        }

        class Cloud {
            constructor() { this.x = Math.random() * width; this.y = Math.random() * (height/3); this.speed = Math.random() * 0.1 + 0.05; this.puffs = []; let puffCount = Math.floor(Math.random() * 5) + 5; for(let i=0; i<puffCount; i++) this.puffs.push({dx: (Math.random() * 100) - 50, dy: (Math.random() * 40) - 20, r: Math.random() * 30 + 30}); }
            update() { this.x += this.speed; if(this.x > width + 100) this.x = -150; }
            draw() {
                ctx.save(); ctx.fillStyle = weather === 'rain' || weather === 'storm' ? 'rgba(40, 45, 60, 0.8)' : 'rgba(240, 245, 255, 0.5)';
                for(let p of this.puffs) { ctx.beginPath(); ctx.arc(this.x + p.dx, this.y + p.dy, p.r, 0, Math.PI*2); ctx.fill(); }
                ctx.restore();
            }
        }

        class Pedestrian {
            constructor() {
                this.direction = Math.random() > 0.5 ? 1 : -1; this.x = this.direction === 1 ? -20 : width + 20; this.y = sidewalkLevel;
                this.speed = (Math.random() * 0.5 + 0.5) * this.direction;
                this.color = ['#e74c3c', '#f1c40f', '#9b59b6', '#2ecc71', '#ecf0f1'][Math.floor(Math.random()*5)];
                this.walkFrame = 0; this.updateProps();
            }
            updateProps() { 
                this.hasUmbrella = (weather === 'rain' || weather === 'storm');
                this.hasScarf = (season === 'winter' || weather === 'snow');
                this.umbrellaColor = ['#333', '#555', '#222', '#444'][Math.floor(Math.random()*4)]; 
            }
            update() { this.x += this.speed; this.walkFrame += 0.15; }
            draw() {
                let bob = Math.sin(this.walkFrame) * 2;
                ctx.fillStyle = '#222'; ctx.fillRect(this.x, this.y - 15, 3, 15); 
                ctx.fillStyle = this.color; ctx.fillRect(this.x - 3, this.y - 30 + bob, 9, 18);
                ctx.fillStyle = '#f1c40f'; ctx.beginPath(); ctx.arc(this.x + 1.5, this.y - 32 + bob, 3, 0, Math.PI*2); ctx.fill();
                
                if (this.hasUmbrella) {
                    ctx.fillStyle = this.umbrellaColor; ctx.beginPath(); ctx.arc(this.x + 1.5, this.y - 32 + bob, 12, Math.PI, 0); ctx.fill();
                    ctx.strokeStyle = '#555'; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(this.x + 1.5, this.y - 25 + bob); ctx.lineTo(this.x + 1.5, this.y - 35 + bob); ctx.stroke();
                } 
                if (this.hasScarf) {
                    ctx.fillStyle = '#e74c3c'; ctx.fillRect(this.x - 2, this.y - 25 + bob, 7, 3);
                }
            }
        }

        class Particle { 
            constructor(type) { this.type = type; this.reset(); }
            reset() {
                this.x = Math.random() * (width + 400) - 200; this.y = Math.random() * -height; this.z = Math.random() * 0.8 + 0.2; 
                this.sway = Math.random() * 100;
                
                if (this.type === 'rain') { this.speed = (15 + Math.random() * 5) * this.z; this.len = Math.random() * 20 + 10; } 
                else if (this.type === 'snow') { this.speed = (1 + Math.random() * 2) * this.z; this.size = Math.random() * 2 * this.z; }
                else if (this.type === 'sand') { 
                    this.speed = (15 + Math.random() * 10) * this.z; this.x = -Math.random()*width; this.y = Math.random() * height; 
                    this.size = Math.random() * 2;
                }
                else if (this.type === 'fog') {
                    this.speed = 0.5 * this.z; this.size = Math.random() * 50 + 20; this.y = Math.random() * height;
                }
            }
            update() {
                if (this.type === 'rain') { this.x += windSpeed * this.z; this.y += this.speed; } 
                else if (this.type === 'snow') { this.sway += 0.05; this.x += Math.sin(this.sway) * 0.5 + (windSpeed * 0.5); this.y += this.speed; }
                else if (this.type === 'sand') { this.x += this.speed; this.y += (Math.random()-0.5); if(this.x > width) this.x = -10; }
                else if (this.type === 'fog') { this.x += this.speed; if(this.x > width + 50) this.x = -50; }

                if (this.y > height && this.type !== 'sand' && this.type !== 'fog') this.reset();
                if (this.y > groundLevel && this.type === 'rain') { this.splash(this.x, groundLevel); this.reset(); }
            }
            splash(x, y) { if(Math.random() > 0.8) splashes.push(new Splash(x, y, false)); if(Math.random() > 0.95) splashes.push(new Ripple(x, y)); }
            draw() {
                if (this.type === 'rain') { ctx.strokeStyle = `rgba(200, 210, 230, ${0.3 * this.z})`; ctx.lineWidth = 1 * this.z; ctx.beginPath(); ctx.moveTo(this.x, this.y); ctx.lineTo(this.x - windSpeed, this.y - this.len); ctx.stroke(); } 
                else if (this.type === 'snow') { ctx.fillStyle = `rgba(255, 255, 255, ${0.6 * this.z})`; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill(); }
                else if (this.type === 'sand') { ctx.fillStyle = `rgba(194, 178, 128, ${0.6 * this.z})`; ctx.fillRect(this.x, this.y, this.size*2, 1); }
                else if (this.type === 'fog') { ctx.fillStyle = `rgba(255, 255, 255, ${0.05 * this.z})`; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill(); }
            }
        }

        class Hawker {
            constructor(x) {
                this.x = x; this.y = sidewalkLevel;
                this.type = Math.random() > 0.4 ? 'tenda' : 'gerobak';
                this.color = this.type === 'tenda' ? (Math.random() > 0.5 ? '#d35400' : '#2980b9') : '#8e44ad';
                this.width = this.type === 'tenda' ? 70 : 40; this.height = this.type === 'tenda' ? 45 : 30; this.lightFlicker = 0;
            }
            draw() {
                ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillRect(this.x + 5, this.y, this.width - 10, 5);
                if (this.type === 'tenda') {
                    ctx.fillStyle = this.color; ctx.beginPath(); ctx.moveTo(this.x, this.y); ctx.lineTo(this.x + 5, this.y - this.height); ctx.lineTo(this.x + this.width - 5, this.y - this.height); ctx.lineTo(this.x + this.width, this.y); ctx.fill();
                    ctx.strokeStyle = 'rgba(0,0,0,0.2)'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(this.x + this.width/2, this.y); ctx.lineTo(this.x + this.width/2, this.y - this.height); ctx.stroke();
                    ctx.fillStyle = '#ecf0f1'; ctx.fillRect(this.x + 2, this.y - 15, this.width - 4, 12);
                    ctx.fillStyle = '#c0392b'; ctx.fillRect(this.x + 5, this.y - 12, this.width - 10, 2); ctx.fillRect(this.x + 5, this.y - 8, this.width - 20, 2);
                } else {
                    ctx.fillStyle = '#795548'; ctx.fillRect(this.x, this.y - this.height, this.width, this.height);
                    ctx.fillStyle = 'rgba(200, 240, 255, 0.3)'; ctx.fillRect(this.x + 2, this.y - this.height + 2, this.width - 4, this.height/2);
                    ctx.fillStyle = '#333'; ctx.beginPath(); ctx.arc(this.x + 10, this.y, 8, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(this.x + this.width - 10, this.y, 8, 0, Math.PI*2); ctx.fill();
                    ctx.fillStyle = '#95a5a6'; ctx.beginPath(); ctx.moveTo(this.x - 5, this.y - this.height); ctx.lineTo(this.x + this.width + 5, this.y - this.height); ctx.lineTo(this.x + this.width/2, this.y - this.height - 10); ctx.fill();
                }
                this.lightFlicker++; let intensity = Math.sin(this.lightFlicker * 0.5) * 0.1 + 0.9;
                ctx.save(); ctx.globalCompositeOperation = 'screen'; ctx.fillStyle = `rgba(255, 220, 100, ${0.6 * intensity})`; ctx.beginPath(); ctx.arc(this.x + this.width/2, this.y - this.height/2, 20, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(this.x + this.width/2, this.y - this.height + 10, 2, 0, Math.PI*2); ctx.fill(); ctx.restore();
            }
        }

        class Building {
            constructor(x, w, h, type, hasHelipad = false) {
                this.x = x; this.w = w; this.h = h; this.type = type; this.hasHelipad = hasHelipad;
                this.windows = [];
                this.baseColor = type === 'mall' ? '#bdc3c7' : (type === 'apt' ? '#7f8c8d' : '#34495e');
                let rows = Math.floor(h / 25); let cols = Math.floor(w / 20);
                for(let r=1; r<rows; r++) {
                    for(let c=1; c<cols; c++) {
                        if (Math.random() > 0.1) this.windows.push({ x: x + (c * 20), y: sidewalkLevel - h + (r * 25), w: 12, h: 18, on: Math.random() > 0.6, timer: Math.random() * 1000 });
                    }
                }
            }
            update() { for(let w of this.windows) { w.timer--; if(w.timer <= 0) { w.on = !w.on; w.timer = Math.random() * 2000 + 500; } } }
            draw() {
                let grad = ctx.createLinearGradient(this.x, sidewalkLevel - this.h, this.x + 20, sidewalkLevel);
                grad.addColorStop(0, this.baseColor); grad.addColorStop(1, '#1a252f');
                ctx.fillStyle = grad; ctx.fillRect(this.x, sidewalkLevel - this.h, this.w, this.h);
                ctx.fillStyle = '#2c3e50'; ctx.fillRect(this.x - 5, sidewalkLevel - this.h, this.w + 10, 5);
                for(let w of this.windows) {
                    if (w.on) { ctx.fillStyle = 'rgba(255, 240, 200, 0.6)'; ctx.shadowColor = "orange"; ctx.shadowBlur = 2; ctx.fillRect(w.x, w.y, w.w, w.h); ctx.shadowBlur = 0; } 
                    else { ctx.fillStyle = '#151b21'; ctx.fillRect(w.x, w.y, w.w, w.h); ctx.fillStyle = 'rgba(255,255,255,0.05)'; ctx.beginPath(); ctx.moveTo(w.x, w.y); ctx.lineTo(w.x+w.w, w.y+w.h/2); ctx.lineTo(w.x, w.y+w.h); ctx.fill(); }
                }
                if(this.type === 'mall') { ctx.fillStyle = '#e74c3c'; ctx.font = 'bold 16px sans-serif'; ctx.fillText("PLAZA", this.x + 20, sidewalkLevel - this.h + 20); }
                if (this.hasHelipad) {
                    ctx.save(); ctx.translate(this.x + this.w/2, sidewalkLevel - this.h); ctx.scale(1, 0.3); 
                    ctx.fillStyle = '#333'; ctx.beginPath(); ctx.arc(0, 0, 30, 0, Math.PI*2); ctx.fill();
                    ctx.strokeStyle = '#f1c40f'; ctx.lineWidth = 3; ctx.beginPath(); ctx.arc(0, 0, 25, 0, Math.PI*2); ctx.stroke();
                    ctx.fillStyle = '#f1c40f'; ctx.font = 'bold 30px Arial'; ctx.textAlign = 'center'; ctx.fillText('H', 0, 10);
                    ctx.restore();
                }
            }
        }

        class StreetLight {
            constructor(x, y) { this.x = x; this.y = y; this.h = 160; }
            draw() {
                ctx.fillStyle = '#222'; ctx.fillRect(this.x - 2, this.y - this.h, 4, this.h);
                ctx.beginPath(); ctx.moveTo(this.x, this.y - this.h); ctx.lineTo(this.x + 30, this.y - this.h - 5); ctx.strokeStyle = '#222'; ctx.lineWidth = 3; ctx.stroke();
                ctx.save(); ctx.globalCompositeOperation = 'screen';
                let grad = ctx.createRadialGradient(this.x + 30, this.y - this.h - 5, 2, this.x + 30, this.y, 120);
                grad.addColorStop(0, 'rgba(255, 240, 200, 0.4)'); grad.addColorStop(1, 'rgba(0,0,0,0)');
                ctx.fillStyle = grad; ctx.beginPath(); ctx.moveTo(this.x + 30, this.y - this.h - 5); ctx.lineTo(this.x - 40, this.y); ctx.lineTo(this.x + 100, this.y); ctx.fill(); ctx.restore();
            }
        }

        class Vehicle {
            constructor() {
                this.type = Math.random() > 0.7 ? 'car' : (Math.random() > 0.5 ? 'bike' : 'bus');
                this.direction = 1; this.x = -150; this.speed = (Math.random() * 2 + 3);
                
                this.color = ['#ecf0f1', '#e74c3c', '#3498db'][Math.floor(Math.random()*3)];
                if(this.type === 'bus') {
                    this.speed *= 0.8; this.isStopping = false; this.stopTimer = 0; this.hasStoppedAtStop = false;
                    this.color = '#f1c40f';
                }
                if(this.type === 'bike') {
                    this.speed *= 1.5; 
                    this.color = '#222'; 
                }

                this.y = groundLevel - 5; if (this.type === 'bus') this.y -= 20; this.passengersAnim = [];
            }
            update() { 
                if (this.type === 'bus' && !this.hasStoppedAtStop && busStop) {
                    let dist = this.x - busStop.x;
                    if (dist > -150 && dist < 0) { this.isStopping = true; this.speed *= 0.95; 
                        if (this.speed < 0.1) { this.speed = 0; this.stopTimer++; 
                            if (this.stopTimer % 20 === 0 && this.stopTimer < 150) this.passengersAnim.push({x: this.x + 80 + (Math.random()*10), y: this.y + 20, alpha: 1, type: Math.random()>0.5?'in':'out'});
                            if (this.stopTimer > 200) { this.hasStoppedAtStop = true; this.isStopping = false; }
                        }
                    } else if (this.hasStoppedAtStop) { if (this.speed < 2.5) this.speed += 0.05; }
                }
                this.x += this.speed; 
                for(let i=this.passengersAnim.length-1; i>=0; i--) { let p = this.passengersAnim[i]; p.alpha -= 0.05; p.y += (p.type==='out' ? 1 : -1); if(p.alpha <= 0) this.passengersAnim.splice(i, 1); }
                if(Math.random() > 0.3 && weather === 'rain' && this.speed > 1) splashes.push(new Splash(this.x + (this.type==='bike'?15:5), groundLevel, true)); 
            }
            draw() {
                ctx.save();
                if(this.type === 'car') { 
                    ctx.fillStyle = this.color; ctx.fillRect(this.x, this.y - 15, 60, 20); 
                    ctx.fillStyle = '#2c3e50'; ctx.fillRect(this.x + 5, this.y - 22, 50, 10); 
                }
                else if (this.type === 'bus') { 
                    ctx.fillStyle = this.color; ctx.fillRect(this.x, this.y - 25, 120, 45); 
                    ctx.fillStyle = '#34495e'; ctx.fillRect(this.x + 5, this.y - 20, 110, 15); ctx.fillStyle='#222'; ctx.fillRect(this.x + 60, this.y, 20, 20); 
                }
                else { 
                    ctx.fillStyle = this.color; ctx.fillRect(this.x, this.y - 10, 30, 15); 
                    ctx.fillStyle = '#d35400'; ctx.beginPath(); ctx.arc(this.x + 15, this.y - 15, 6, 0, Math.PI*2); ctx.fill(); 
                }
                ctx.globalCompositeOperation = 'screen'; let beamLen = this.type === 'bike' ? 80 : 120;
                let grad = ctx.createLinearGradient(this.x, this.y, this.x + (beamLen * this.direction), this.y);
                grad.addColorStop(0, 'rgba(255, 255, 200, 0.6)'); grad.addColorStop(1, 'rgba(0,0,0,0)'); ctx.fillStyle = grad; 
                ctx.beginPath(); ctx.moveTo(this.x + (this.type==='bike'?30:60), this.y); ctx.lineTo(this.x + (this.type==='bike'?30:60) + beamLen, this.y + 20); ctx.lineTo(this.x + (this.type==='bike'?30:60), this.y - 10); ctx.fill(); 
                ctx.fillStyle = 'rgba(255,0,0,0.8)'; ctx.fillRect(this.x, this.y-5, 2, 5); ctx.restore();
                this.passengersAnim.forEach(p => { ctx.fillStyle = `rgba(200, 200, 200, ${p.alpha})`; ctx.fillRect(p.x, p.y, 4, 8); });
            }
        }

        class Splash {
            constructor(x, y, isBig) { this.x = x; this.y = y; this.vx = (Math.random() - 0.5) * 4; this.vy = (Math.random() * -3) - 1; this.life = isBig ? 15 : 8; }
            update() { this.x += this.vx; this.y += this.vy; this.vy += 0.5; this.life--; }
            draw() { ctx.fillStyle = `rgba(200,220,255,${this.life/15})`; ctx.fillRect(this.x, this.y, 2, 2); }
        }

        class Ripple {
            constructor(x, y) { this.x = x; this.y = y; this.r = 1; this.op = 0.5; }
            update() { this.r += 0.5; this.op -= 0.05; }
            draw() { ctx.strokeStyle=`rgba(200,220,255,${this.op})`; ctx.beginPath(); ctx.ellipse(this.x, this.y, this.r, this.r*0.3, 0,0,7); ctx.stroke(); }
        }

        // --- AUTO MODE LOGIC ---
        function toggleAutoMode() {
            const toggle = document.getElementById('autoToggle');
            const slider = document.getElementById('atmosphereSlider');
            const loading = document.getElementById('loading-text');
            const label = document.getElementById('atmosphereLabel');
            
            isAutoMode = toggle.checked;
            
            if (isAutoMode) {
                slider.disabled = true;
                slider.style.opacity = 0.5;
                loading.style.display = 'block';
                label.innerText = "Mendeteksi Lokasi...";
                
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        fetchWeatherData, 
                        (err) => {
                            console.warn("GPS Error/Denied, using fallback Jakarta");
                            loading.innerText = "GPS Gagal, pakai Default (JKT)";
                            const jakarta = { coords: { latitude: -6.2088, longitude: 106.8456 } };
                            fetchWeatherData(jakarta);
                        },
                        { timeout: 5000 }
                    );
                } else {
                    const jakarta = { coords: { latitude: -6.2088, longitude: 106.8456 } };
                    fetchWeatherData(jakarta);
                }
            } else {
                slider.disabled = false;
                slider.style.opacity = 1;
                loading.style.display = 'none';
                updateAtmosphere(); 
            }
        }

        async function fetchWeatherData(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const loading = document.getElementById('loading-text');
            
            try {
                loading.innerText = "Mengambil data cuaca...";
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`);
                const data = await response.json();
                
                if (!isAutoMode) return; 

                const wmoCode = data.current_weather.weathercode;
                const isDay = data.current_weather.is_day === 1;
                const temp = data.current_weather.temperature;
                const date = new Date();
                const month = date.getMonth(); 

                applyAutoAtmosphere(wmoCode, isDay, month, temp);
                loading.style.display = 'none';
                
            } catch (e) {
                console.error(e);
                document.getElementById('atmosphereLabel').innerText = "Gagal memuat data.";
                loading.style.display = 'none';
            }
        }

        function applyAutoAtmosphere(code, isDay, month, temp) {
            const label = document.getElementById('atmosphereLabel');
            const panel = document.getElementById('controls-panel');
            
            if (temp > 30) season = 'summer'; 
            else if (month >= 2 && month <= 4) season = 'spring';
            else if (month >= 5 && month <= 7) season = 'summer';
            else if (month >= 8 && month <= 10) season = 'autumn';
            else season = 'winter';

            let weatherDesc = "Cerah";
            if (code <= 3) { weather = 'clear'; weatherDesc = "Cerah/Berawan"; }
            else if (code >= 45 && code <= 48) { weather = 'fog'; weatherDesc = "Berkabut"; }
            else if (code >= 51 && code <= 67) { weather = 'rain'; weatherDesc = "Hujan"; }
            else if (code >= 71 && code <= 86) { weather = 'snow'; weatherDesc = "Salju"; }
            else if (code >= 95) { weather = 'storm'; weatherDesc = "Badai"; }
            else weather = 'clear'; 

            if (weather === 'snow') season = 'winter';

            particles.length = 0;
            windSpeed = 1;
            lightningChance = 0;
            
            label.innerText = `${weatherDesc} (${temp}Â°C) ${isDay ? 'â˜€ï¸' : 'ðŸŒ™'}`;
            panel.style.borderLeftColor = "#3498db"; 

            if (isDay) {
                if (weather === 'clear') { skyColorTop = '#3498db'; skyColorBot = '#87ceeb'; riverColorTop = '#3498db'; }
                else if (weather === 'rain') { skyColorTop = '#7f8c8d'; skyColorBot = '#bdc3c7'; riverColorTop = '#546e7a'; }
                else { skyColorTop = '#95a5a6'; skyColorBot = '#ecf0f1'; riverColorTop = '#78909c'; }
                overlayColor = 'rgba(0,0,0,0)';
            } else {
                skyColorTop = '#050510'; skyColorBot = '#2c3e50'; riverColorTop = '#1a252f';
                overlayColor = 'rgba(0,0,20,0.5)';
            }

            if (weather === 'rain') {
                windSpeed = 2;
                initParticles('rain', 800);
            } else if (weather === 'storm') {
                windSpeed = 5;
                lightningChance = 0.03;
                initParticles('rain', 1500);
                if(isDay) { skyColorTop = '#2c3e50'; skyColorBot = '#34495e'; riverColorTop = '#263238'; } 
            } else if (weather === 'snow') {
                windSpeed = 0.5;
                initParticles('snow', 900);
            } else if (weather === 'fog') {
                overlayColor = isDay ? 'rgba(255,255,255,0.6)' : 'rgba(100,100,100,0.6)';
                initParticles('fog', 400);
            }

            pedestrians.forEach(p => p.updateProps());
        }

        // --- MANUAL SLIDER LOGIC ---
        function updateAtmosphere() {
            if (isAutoMode) return; 

            const val = parseInt(document.getElementById('atmosphereSlider').value);
            const label = document.getElementById('atmosphereLabel');
            const panel = document.getElementById('controls-panel');

            lightningChance = 0;
            windSpeed = 1;
            particles.length = 0;

            switch(val) {
                case 0: // Spring Clear
                    season = 'spring'; weather = 'clear';
                    label.innerText = "Musim Semi Cerah ðŸŒ¸";
                    panel.style.borderLeftColor = "#2ecc71"; 
                    skyColorTop = '#3498db'; skyColorBot = '#87ceeb';
                    riverColorTop = '#3498db';
                    overlayColor = 'rgba(0,0,0,0)';
                    break;
                case 1: // Summer Heatwave
                    season = 'summer'; weather = 'heatwave';
                    label.innerText = "Gelombang Panas â˜€ï¸";
                    panel.style.borderLeftColor = "#e74c3c"; 
                    skyColorTop = '#e74c3c'; skyColorBot = '#f1c40f';
                    riverColorTop = '#2980b9';
                    overlayColor = 'rgba(255, 100, 0, 0.15)';
                    windSpeed = 0.1;
                    break;
                case 2: // Autumn Rain
                    season = 'autumn'; weather = 'rain';
                    label.innerText = "Hujan Musim Gugur ðŸ‚";
                    panel.style.borderLeftColor = "#d35400"; 
                    skyColorTop = '#2c3e50'; skyColorBot = '#bdc3c7';
                    riverColorTop = '#546e7a';
                    overlayColor = 'rgba(0,0,10,0.2)';
                    windSpeed = 2;
                    initParticles('rain', 800);
                    break;
                case 3: // Winter Snow
                    season = 'winter'; weather = 'snow';
                    label.innerText = "Badai Salju â„ï¸";
                    panel.style.borderLeftColor = "#ecf0f1"; 
                    skyColorTop = '#7f8c8d'; skyColorBot = '#ecf0f1';
                    riverColorTop = '#90a4ae'; // Icy water
                    overlayColor = 'rgba(255,255,255,0.1)';
                    windSpeed = 0.5;
                    initParticles('snow', 900);
                    break;
                case 4: // Storm
                    season = 'summer'; weather = 'storm';
                    label.innerText = "Badai Petir â›ˆï¸";
                    panel.style.borderLeftColor = "#8e44ad"; 
                    skyColorTop = '#050505'; skyColorBot = '#2c3e50';
                    riverColorTop = '#1c2833';
                    overlayColor = 'rgba(0,0,10,0.5)';
                    windSpeed = 5;
                    lightningChance = 0.03;
                    initParticles('rain', 1500);
                    break;
                case 5: // Fog
                    season = 'spring'; weather = 'fog';
                    label.innerText = "Kabut Tebal ðŸŒ«ï¸";
                    panel.style.borderLeftColor = "#95a5a6"; 
                    skyColorTop = '#bdc3c7'; skyColorBot = '#ecf0f1'; 
                    riverColorTop = '#7f8c8d';
                    overlayColor = 'rgba(220,230,240,0.7)';
                    windSpeed = 0.2;
                    initParticles('fog', 400);
                    break;
                case 6: // Sandstorm
                    season = 'summer'; weather = 'sandstorm';
                    label.innerText = "Badai Pasir ðŸœï¸";
                    panel.style.borderLeftColor = "#f39c12"; 
                    skyColorTop = '#d35400'; skyColorBot = '#f39c12';
                    riverColorTop = '#d35400';
                    overlayColor = 'rgba(194, 178, 128, 0.5)';
                    windSpeed = 10;
                    initParticles('sand', 1500);
                    break;
            }
            pedestrians.forEach(p => p.updateProps());
        }

        function initParticles(type, count) {
            for(let i=0; i<count; i++) particles.push(new Particle(type));
        }

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            // Layout Update: Sungai di Bawah
            riverLevel = height - 120; // Mulai sungai (dari atas)
            groundLevel = riverLevel - 60; // Mulai jalan raya (di atas sungai)
            sidewalkLevel = groundLevel - 15; // Mulai trotoar
            
            initWorld();
            updateAtmosphere(); 
        }

        function initWorld() {
            buildings = [];
            cityscapeLayers = [];
            streetLights = [];
            hawkers = [];
            helicopters = [];
            boats.length = 0;
            vehicles.length = 0;
            
            cityscapeLayers.push(generateCityLayer(200, 150, '#1f2a36', 0.5));
            cityscapeLayers.push(generateCityLayer(100, 250, '#2c3e50', 0.8));

            monorail = new MonorailSystem(sidewalkLevel - 200);
            highSpeedTrain = new HighSpeedTrainSystem(sidewalkLevel - 350);

            buildings.push(new Building(0, 150, 300, 'office'));
            buildings.push(new Building(160, 120, 220, 'apt'));
            buildings.push(new Building(width - 250, 200, 380, 'mall', true)); 
            buildings.push(new Building(width/2 - 50, 140, 280, 'office'));

            busStop = new BusStop(300, sidewalkLevel);

            let hawkerSpots = [width/2 + 120, width - 100, 100];
            hawkerSpots.forEach(x => {
                if(Math.abs(x - 300) > 80) hawkers.push(new Hawker(x));
            });

            let lightSpacing = width / 4;
            for(let i = 80; i < width; i += lightSpacing) {
                streetLights.push(new StreetLight(i, sidewalkLevel)); 
            }

            clouds.length = 0;
            for(let i=0; i<5; i++) clouds.push(new Cloud());
        }

        function generateCityLayer(avgWidth, avgHeight, color, speedFactor) {
            let layer = [];
            let cx = -50;
            while(cx < width + 100) {
                let w = Math.random() * avgWidth + 50;
                let h = Math.random() * avgHeight + 80;
                let windows = [];
                if (Math.random() > 0.3) {
                     let rows = h / 20;
                     let cols = w / 15;
                     for(let r=1; r<rows; r+=2) {
                        for(let c=1; c<cols; c+=2) {
                            if(Math.random() > 0.6) windows.push({x: c*15, y: r*20});
                        }
                     }
                }
                layer.push({x: cx, w: w, h: h, color: color, windows: windows});
                cx += w - (Math.random() * 5);
            }
            return layer;
        }

        // --- DRAWING FUNCTIONS ---

        function drawTree(startX, startY, len, angle, width) {
            ctx.beginPath();
            ctx.save();
            ctx.strokeStyle = '#151515';
            ctx.lineWidth = width;
            ctx.translate(startX, startY);
            ctx.rotate(angle * Math.PI/180);
            ctx.moveTo(0,0);
            ctx.lineTo(0, -len);
            ctx.stroke();

            // DAUN POHON
            if (len < 15) {
                let leafColor;
                if (season === 'spring') leafColor = 'rgba(255, 183, 197, 0.7)'; 
                else if (season === 'summer') leafColor = 'rgba(46, 204, 113, 0.7)'; 
                else if (season === 'autumn') leafColor = 'rgba(230, 126, 34, 0.7)'; 
                else leafColor = 'rgba(255, 255, 255, 0)'; 
                
                if (season !== 'winter') {
                    ctx.fillStyle = leafColor;
                    ctx.beginPath();
                    ctx.arc(0, -len, 5, 0, Math.PI*2);
                    ctx.fill();
                } else if (season === 'winter' && weather === 'snow') {
                     ctx.fillStyle = 'rgba(255,255,255,0.6)';
                     ctx.fillRect(-2, -len, 4, 2);
                }
            }

            if(len < 10) { ctx.restore(); return; }

            ctx.translate(0, -len);
            let sway = Math.sin(Date.now() / 1000 + startX) * (windSpeed); 
            
            drawTree(0, 0, len * 0.7, angle + 20 + sway, width * 0.7);
            drawTree(0, 0, len * 0.7, angle - 20 + sway, width * 0.7);
            
            ctx.restore();
        }

        function triggerLightning() {
            if (Math.random() > lightningChance) return; 
            
            flashOpacity = 0.4;
            let startX = Math.random() * width;
            let bolt = [];
            let curr = {x: startX, y: 0};
            let limitY = sidewalkLevel - 300; 
            
            while(curr.y < limitY) {
                bolt.push({...curr});
                curr.y += Math.random() * 20 + 10;
                curr.x += (Math.random() - 0.5) * 60;
            }
            thunderBolts.push({path: bolt, life: 5});
        }

        function animate() {
            windVariance = Math.sin(Date.now() / 3000); 

            if (lightningTimer <= 0) {
                 triggerLightning();
                 lightningTimer = Math.random() * 300 + 100;
            } else lightningTimer--;

            if (vehicleTimer <= 0) { if (Math.random() < 0.03) { vehicles.push(new Vehicle()); vehicleTimer = 80; } } else vehicleTimer--;
            if (pedestrianTimer <= 0) { if (Math.random() < 0.03) { pedestrians.push(new Pedestrian()); pedestrianTimer = 60; } } else pedestrianTimer--;
            if (heliTimer <= 0) { if (Math.random() < 0.01) { helicopters.push(new Helicopter()); heliTimer = 500; } } else heliTimer--;
            
            // Boat Spawner
            if (boatTimer <= 0) { if (Math.random() < 0.01) { boats.push(new Boat()); boatTimer = 150; } } else boatTimer--;

            monorail.update();
            highSpeedTrain.update();

            // --- DRAWING ---
            let skyGrad = ctx.createLinearGradient(0, 0, 0, height);
            skyGrad.addColorStop(0, skyColorTop); 
            skyGrad.addColorStop(1, skyColorBot);
            ctx.fillStyle = skyGrad;
            ctx.fillRect(0, 0, width, height);

            cityscapeLayers.forEach(layer => {
                ctx.fillStyle = layer[0].color;
                layer.forEach(b => {
                   ctx.fillRect(b.x, sidewalkLevel - b.h, b.w, b.h);
                   if (b.windows) {
                        ctx.fillStyle = 'rgba(200, 200, 200, 0.2)';
                        for(let w of b.windows) if (w.y < b.h) ctx.fillRect(b.x + w.x, sidewalkLevel - b.h + w.y, 8, 12);
                   }
                   ctx.fillStyle = layer[0].color;
                });
            });

            highSpeedTrain.drawTrack(); highSpeedTrain.drawTrain();
            monorail.drawTrack(); monorail.drawTrain();

            clouds.forEach(c => { c.update(); c.draw(); });

            for(let i=helicopters.length-1; i>=0; i--) { let remove = helicopters[i].update(); helicopters[i].draw(); if(remove) helicopters.splice(i, 1); }

            if (flashOpacity > 0) {
                ctx.fillStyle = `rgba(255, 255, 255, ${flashOpacity})`;
                ctx.fillRect(0, 0, width, height);
                flashOpacity -= 0.05;
            }
            ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.shadowBlur = 10; ctx.shadowColor = "white";
            for(let i=thunderBolts.length-1; i>=0; i--) {
                let b = thunderBolts[i];
                ctx.beginPath(); ctx.moveTo(b.path[0].x, b.path[0].y);
                for(let p of b.path) ctx.lineTo(p.x, p.y);
                ctx.stroke();
                b.life--; if(b.life<=0) thunderBolts.splice(i,1);
            }
            ctx.shadowBlur = 0;

            // DRAW GROUND LAYERS
            // 1. Sidewalk
            ctx.fillStyle = '#7f8c8d'; ctx.fillRect(0, sidewalkLevel, width, groundLevel - sidewalkLevel);
            // 2. Road
            ctx.fillStyle = (weather === 'snow' || season === 'winter') ? '#95a5a6' : '#34495e'; 
            ctx.fillRect(0, groundLevel, width, riverLevel - groundLevel);
            // 3. River
            let riverGrad = ctx.createLinearGradient(0, riverLevel, 0, height);
            riverGrad.addColorStop(0, riverColorTop);
            riverGrad.addColorStop(1, riverColorBot);
            ctx.fillStyle = riverGrad;
            ctx.fillRect(0, riverLevel, width, height - riverLevel);
            // River railing
            ctx.fillStyle = '#2c3e50'; ctx.fillRect(0, riverLevel - 5, width, 5); // Curb
            ctx.fillStyle = '#95a5a6';
            for(let i=0; i<width; i+=40) ctx.fillRect(i, riverLevel - 15, 5, 15); // Posts
            ctx.fillRect(0, riverLevel - 15, width, 3); // Rail

            buildings.forEach(b => { b.update(); b.draw(); });

            busStop.draw(); hawkers.forEach(h => h.draw()); streetLights.forEach(l => l.draw());

            drawTree(width * 0.1, sidewalkLevel, 50, windVariance * 3, 6);
            drawTree(width * 0.9, sidewalkLevel, 65, windVariance * 3, 8);

            pedestrians.forEach((p, i) => { p.update(); p.draw(); if (p.x < -50 || p.x > width + 50) pedestrians.splice(i, 1); });
            
            vehicles.forEach((v, i) => { v.update(); v.draw(); if(v.x < -200 || v.x > width + 200) vehicles.splice(i, 1); });

            // Boats
            for(let i=boats.length-1; i>=0; i--) { let remove = boats[i].update(); boats[i].draw(); if(remove) boats.splice(i, 1); }

            splashes.forEach((s, i) => { s.update(); s.draw(); if(s.life<=0) splashes.splice(i,1); });
            particles.forEach(p => { p.update(); p.draw(); });

            ctx.fillStyle = overlayColor;
            ctx.fillRect(0,0,width,height);
            
            if (weather === 'heatwave') {
                let heatPulse = Math.abs(Math.sin(Date.now() / 1000)) * 0.1;
                ctx.fillStyle = `rgba(255, 100, 0, ${heatPulse})`;
                ctx.fillRect(0,0,width,height);
            }

            requestAnimationFrame(animate);
        }

        window.addEventListener('resize', resize);
        resize(); // Init pertama kali
        animate(); // Start animation loop
    </script>
</body>
</html>
