<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grafik User Online (Bar)</title>
    <!-- Memuat Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Chart.js untuk grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .status-dot {
            height: 12px;
            width: 12px;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(22, 163, 74, 0); }
            100% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0); }
        }
        .status-dot.inactive {
            animation: none;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800 flex items-center justify-center min-h-screen">
    <!-- Container utama widget -->
    <div class="w-full max-w-[400px] bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="p-6">
            <!-- Header -->
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-baseline space-x-2">
                    <h1 id="site-title" class="text-lg font-bold text-gray-800">Memuat...</h1>
                    <span id="header-user-count" class="text-xl font-bold text-blue-600">-</span>
                </div>
                <div class="flex items-center space-x-3">
                    <a id="stats-link" href="#" target="_blank" title="Lihat Statistik Lengkap">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 hover:text-blue-600"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
                    </a>
                    <div id="status-icon" class="status-dot bg-gray-400 inactive" title="Status"></div>
                </div>
            </div>
            
            <!-- Area Grafik -->
            <div class="relative aspect-[16/9]">
                <canvas id="userChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // ===================================================================================
        // --- KONFIGURASI WIDGET ---
        // ===================================================================================
        const config = {
            workerUrl: 'https://ccuhistatsemas3.nyamtad.workers.dev/',
            monitoredSite: 'emas3.ui.ac.id',
            statsUrl: 'https://www.histats.com/viewstats/?SID=4919902&f=2',
            updateInterval: 10000,
        };
        // ===================================================================================

        const statusIcon = document.getElementById('status-icon');
        const chartCanvas = document.getElementById('userChart');
        const headerUserCount = document.getElementById('header-user-count');
        const siteTitle = document.getElementById('site-title');
        const statsLink = document.getElementById('stats-link');

        let chart;
        let minuteDataBuffer = []; 
        let minuteAverages = [];
        let lastKnownUserCount = null;
        let consecutiveFailures = 0;
        let isProcessing = false;
        let processingStartTime = 0; // Variabel baru untuk mengontrol animasi

        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        async function getHistatsOnlineCount(workerUrl, retries = 1) {
            for (let i = 0; i <= retries; i++) {
                try {
                    const response = await fetch(`${workerUrl}?_=${new Date().getTime()}`);
                    if (!response.ok) {
                        throw new Error(`Gagal mengambil data, status: ${response.status}`);
                    }
                    const data = await response.json();
                    return data.livearray.livesummary.cur_online;
                } catch (error) {
                    console.error(`Percobaan ${i + 1} gagal:`, error.message);
                    if (i < retries) {
                        await sleep(2000);
                    } else {
                        return null;
                    }
                }
            }
        }
        
        async function fetchAndProcessData() {
            isProcessing = true;
            processingStartTime = Date.now(); // Catat waktu mulai proses
            updateStatus('blue', false);
            const userCount = await getHistatsOnlineCount(config.workerUrl);
            isProcessing = false;
            
            if (userCount !== null && userCount > 0) {
                consecutiveFailures = 0;
                lastKnownUserCount = userCount;
                headerUserCount.textContent = userCount;
                addDataToChart(userCount, false);
            } else {
                consecutiveFailures++;
                if (lastKnownUserCount !== null && consecutiveFailures < 6) {
                    headerUserCount.textContent = lastKnownUserCount;
                    addDataToChart(lastKnownUserCount, true);
                    updateStatus('yellow', true);
                } else {
                    headerUserCount.textContent = 'X';
                    updateStatus('red', false);
                }
            }
        }

        async function runProcessLoop() {
            await fetchAndProcessData();
            if (consecutiveFailures < 6) {
                updateStatus('green', true);
            }
            setTimeout(runProcessLoop, config.updateInterval);
        }

        function addDataToChart(userCount, isStale) {
            const now = new Date();
            
            minuteDataBuffer.push({ value: userCount, isStale: isStale, time: now });

            if (minuteDataBuffer.length > 6) {
                const toConsolidate = minuteDataBuffer.slice(0, 6);
                const values = toConsolidate.map(d => d.value);
                const sum = values.reduce((acc, data) => acc + data, 0);
                
                const avgData = {
                    mean: Math.round(sum / toConsolidate.length),
                    max: Math.max(...values),
                    min: Math.min(...values),
                    time: toConsolidate[0].time
                };
                
                minuteAverages.push(avgData);
                
                minuteDataBuffer.splice(0, 6);

                const maxHistory = 9;
                if (minuteAverages.length > maxHistory) {
                    minuteAverages.shift();
                }
            }

            const newLabels = [];
            const newData = [];
            const newColors = [];
            
            const liveColor = 'rgba(96, 165, 250, 0.7)';
            const avgColor = 'rgba(30, 64, 175, 0.8)';
            const staleColor = 'rgba(156, 163, 175, 0.6)';

            minuteAverages.forEach((avgData, index) => {
                const relativeMinute = minuteAverages.length - index;
                newLabels.push(`-${relativeMinute}m`);
                newData.push(avgData.mean);
                newColors.push(avgColor);
            });

            minuteDataBuffer.forEach(() => {
                newLabels.push('');
            });
            minuteDataBuffer.forEach(liveData => {
                newData.push(liveData.value);
                const color = liveData.isStale ? staleColor : liveColor;
                newColors.push(color);
            });
            
            chart.data.labels = newLabels;
            chart.data.datasets[0].data = newData;
            chart.data.datasets[0].backgroundColor = newColors;
            
            chart.update('none');
        }

        function updateStatus(color, pulse) {
            statusIcon.className = `status-dot bg-${color}-500 ${pulse ? '' : 'inactive'}`;
        }
        
        const customIndicators = {
            id: 'customIndicators',
            afterDraw: (chart) => {
                const consolidatedCount = minuteAverages.length;
                const ctx = chart.ctx;
                const meta = chart.getDatasetMeta(0);
                const chartArea = chart.chartArea;
                
                ctx.save();
                ctx.strokeStyle = 'rgba(30, 64, 175, 0.8)';
                ctx.lineWidth = 2;
                for (let i = 0; i < consolidatedCount; i++) {
                    const bar = meta.data[i];
                    const avgData = minuteAverages[i];
                    const meanY = chart.scales.y.getPixelForValue(avgData.mean);
                    const maxY = chart.scales.y.getPixelForValue(avgData.max);
                    const x = bar.x;

                    ctx.beginPath();
                    ctx.moveTo(x, meanY);
                    ctx.lineTo(x, maxY);
                    ctx.stroke();
                }
                ctx.restore();

                const liveDataCount = minuteDataBuffer.length;
                if (liveDataCount === 0) return;
                
                const startIndex = minuteAverages.length;
                const firstLiveBar = meta.data[startIndex];
                const lastLiveBar = meta.data[meta.data.length - 1];

                if (!firstLiveBar || !lastLiveBar) return;

                const startX = firstLiveBar.x - firstLiveBar.width / 2;
                const endX = lastLiveBar.x + lastLiveBar.width / 2;
                const totalWidth = endX - startX;
                const lineY = chartArea.bottom + 15;
                
                ctx.save();
                ctx.beginPath();
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 2;
                ctx.moveTo(startX, lineY);
                ctx.lineTo(endX, lineY);
                ctx.stroke();

                const progress = liveDataCount / 6;
                const animatedWidth = totalWidth * progress;

                ctx.beginPath();
                ctx.strokeStyle = '#3b82f6';
                ctx.lineWidth = 2;
                ctx.moveTo(startX, lineY);
                ctx.lineTo(startX + animatedWidth, lineY);
                ctx.stroke();

                const liveTime = minuteDataBuffer[0].time;
                const timestamp = `${liveTime.getHours().toString().padStart(2, '0')}:${liveTime.getMinutes().toString().padStart(2, '0')}`;
                
                ctx.fillStyle = '#6b7280';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(timestamp, endX, lineY - 5);
                ctx.restore();

                // --- PERUBAHAN DI SINI: Animasi "Tumbuh" Tunggal ---
                if (isProcessing && lastLiveBar) {
                    ctx.save();
                    const bar = lastLiveBar;
                    const animationDuration = 500; // Durasi animasi dalam milidetik
                    const elapsed = Date.now() - processingStartTime;
                    const growthProgress = Math.min(elapsed / animationDuration, 1);

                    const animatedHeight = bar.height * growthProgress;
                    const animatedY = bar.base - animatedHeight;

                    ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                    ctx.fillRect(bar.x - bar.width / 2, animatedY, bar.width, animatedHeight);
                    ctx.restore();
                }
            }
        };

        function initialize() {
            siteTitle.textContent = `Online ${config.monitoredSite}:`;
            statsLink.href = config.statsUrl;
            updateStatus('gray', false);
            
            const ctx = chartCanvas.getContext('2d');
            chart = new Chart(ctx, {
                type: 'bar',
                plugins: [customIndicators],
                data: {
                    labels: [],
                    datasets: [{
                        label: 'User Online',
                        data: [],
                        backgroundColor: [],
                        borderWidth: 0,
                        barPercentage: 0.9,
                        categoryPercentage: 0.8,
                    }]
                },
                options: {
                    scales: {
                       x: { 
                           display: true,
                           grid: { display: false }
                        },
                       y: { 
                           display: true,
                           beginAtZero: true,
                           ticks: {
                               callback: function(value) { if (value % 1 === 0) return value; }
                           }
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { 
                            enabled: true,
                            callbacks: {
                                title: function(tooltipItems) {
                                    const item = tooltipItems[0];
                                    const index = item.dataIndex;
                                    const originalLabel = item.label;
                                    const consolidatedCount = minuteAverages.length;
                                    let time;
                                    
                                    if (index < consolidatedCount) {
                                        time = minuteAverages[index].time;
                                        const timestamp = `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;
                                        return `${originalLabel} (${timestamp})`;
                                    } else {
                                        const liveIndex = index - consolidatedCount;
                                        if (minuteDataBuffer[liveIndex]) {
                                             time = minuteDataBuffer[liveIndex].time;
                                             const startSecond = Math.floor(liveIndex * 10).toString().padStart(2, '0');
                                             const endSecond = (parseInt(startSecond) + 9).toString().padStart(2, '0');
                                             return `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}:${startSecond}-${endSecond}`;
                                        }
                                    }
                                    return originalLabel;
                                },
                                label: function(context) {
                                    if (context.dataIndex < minuteAverages.length) {
                                        const avgData = minuteAverages[context.dataIndex];
                                        return `Max: ${avgData.max}, Rata²: ${avgData.mean}, Min: ${avgData.min}`;
                                    }
                                    return `Online: ${context.raw}`;
                                }
                            }
                        }
                    }
                }
            });
            
            function animationLoop() {
                if (isProcessing) {
                    chart.update('none');
                }
                requestAnimationFrame(animationLoop);
            }
            requestAnimationFrame(animationLoop);
        }
        
        window.onload = () => {
            initialize();
            runProcessLoop();
        };
    </script>
</body>
</html>

